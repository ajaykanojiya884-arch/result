{"ast":null,"code":"import _objectSpread from\"D:/ajay/Result_Analysis/frontend/node_modules/@babel/runtime/helpers/esm/objectSpread2.js\";// src/context/AuthContext.jsx\nimport React,{createContext,useState,useContext,useEffect,useRef,useCallback}from\"react\";import api from\"../services/api\";import{logout as apiLogout,refreshToken as apiRefreshToken}from\"../services/authService\";import{jsx as _jsx}from\"react/jsx-runtime\";const AuthContext=/*#__PURE__*/createContext(null);export function AuthProvider(_ref){let{children}=_ref;const[user,setUser]=useState(()=>{try{const raw=localStorage.getItem(\"user\");return raw?JSON.parse(raw):null;}catch(_unused){return null;}});const[loading,setLoading]=useState(!user);/* -------------------- Persist user -------------------- */useEffect(()=>{if(user)localStorage.setItem(\"user\",JSON.stringify(user));else localStorage.removeItem(\"user\");},[user]);/* -------------------- Refresh timer -------------------- */const refreshTimerRef=useRef(null);const clearRefreshTimer=useCallback(()=>{if(refreshTimerRef.current){clearTimeout(refreshTimerRef.current);refreshTimerRef.current=null;}},[]);const parseJwt=useCallback(token=>{try{const payload=token.split(\".\")[1];const json=atob(payload.replace(/-/g,\"+\").replace(/_/g,\"/\"));return JSON.parse(json);}catch(_unused2){return null;}},[]);const scheduleRefresh=useCallback(token=>{clearRefreshTimer();try{const payload=parseJwt(token);if(!payload||!payload.exp)return;const expiresAt=payload.exp*1000;const now=Date.now();const timeout=Math.max(1000,expiresAt-now-60*1000);refreshTimerRef.current=setTimeout(async()=>{try{const res=await apiRefreshToken();const newToken=res===null||res===void 0?void 0:res.token;if(newToken){localStorage.setItem(\"authToken\",newToken);scheduleRefresh(newToken);}}catch(_unused3){// ðŸ”’ IMPORTANT: Do nothing if backend is restarting\n}},timeout);}catch(_unused4){// ignore\n}},[clearRefreshTimer,parseJwt]);/* -------------------- Initial auth check -------------------- */useEffect(()=>{let mounted=true;async function checkAuth(){try{if(user){// ðŸ”’ Still verify with backend to ensure token is valid & schedule refresh\nconst token=localStorage.getItem(\"authToken\");if(token)scheduleRefresh(token);}const res=await api.get(\"/auth/me\");if(mounted)setUser(res.data||null);const token=localStorage.getItem(\"authToken\");if(token)scheduleRefresh(token);}catch(_unused5){// not logged in or session expired\nsetUser(null);localStorage.removeItem(\"user\");localStorage.removeItem(\"authToken\");}finally{if(mounted)setLoading(false);}}checkAuth();return()=>{mounted=false;};},[scheduleRefresh]);/* -------------------- LOGIN -------------------- */const login=async data=>{if(!(data!==null&&data!==void 0&&data.token))throw new Error(\"Missing auth token\");localStorage.setItem(\"authToken\",data.token);const me=await api.get(\"/auth/me\");const userObj=_objectSpread(_objectSpread({},me.data||{}),{},{role:data.role,token:data.token});setUser(userObj);scheduleRefresh(data.token);return userObj;};/* -------------------- LOGOUT (CRITICAL FIX) -------------------- */const logout=async()=>{// ðŸ”´ HARD STOP all background refresh\nclearRefreshTimer();try{await apiLogout();// best effort\n}catch(_unused6){// ignore\n}// ðŸ”´ Clear all auth state\nsetUser(null);localStorage.removeItem(\"user\");localStorage.removeItem(\"authToken\");try{sessionStorage.clear();}catch(_unused7){// ignore\n}};/* -------------------- SAFETY CLEANUP -------------------- */useEffect(()=>{return()=>{clearRefreshTimer();};},[clearRefreshTimer]);return/*#__PURE__*/_jsx(AuthContext.Provider,{value:{user,login,logout,loading},children:children});}export function useAuth(){const ctx=useContext(AuthContext);if(!ctx){throw new Error(\"useAuth must be used inside AuthProvider\");}return ctx;}","map":{"version":3,"names":["React","createContext","useState","useContext","useEffect","useRef","useCallback","api","logout","apiLogout","refreshToken","apiRefreshToken","jsx","_jsx","AuthContext","AuthProvider","_ref","children","user","setUser","raw","localStorage","getItem","JSON","parse","_unused","loading","setLoading","setItem","stringify","removeItem","refreshTimerRef","clearRefreshTimer","current","clearTimeout","parseJwt","token","payload","split","json","atob","replace","_unused2","scheduleRefresh","exp","expiresAt","now","Date","timeout","Math","max","setTimeout","res","newToken","_unused3","_unused4","mounted","checkAuth","get","data","_unused5","login","Error","me","userObj","_objectSpread","role","_unused6","sessionStorage","clear","_unused7","Provider","value","useAuth","ctx"],"sources":["D:/ajay/Result_Analysis/frontend/src/context/AuthContext.jsx"],"sourcesContent":["// src/context/AuthContext.jsx\r\nimport React, {\r\n  createContext,\r\n  useState,\r\n  useContext,\r\n  useEffect,\r\n  useRef,\r\n  useCallback,\r\n} from \"react\";\r\nimport api from \"../services/api\";\r\nimport {\r\n  logout as apiLogout,\r\n  refreshToken as apiRefreshToken,\r\n} from \"../services/authService\";\r\n\r\nconst AuthContext = createContext(null);\r\n\r\nexport function AuthProvider({ children }) {\r\n  const [user, setUser] = useState(() => {\r\n    try {\r\n      const raw = localStorage.getItem(\"user\");\r\n      return raw ? JSON.parse(raw) : null;\r\n    } catch {\r\n      return null;\r\n    }\r\n  });\r\n  const [loading, setLoading] = useState(!user);\r\n\r\n  /* -------------------- Persist user -------------------- */\r\n  useEffect(() => {\r\n    if (user) localStorage.setItem(\"user\", JSON.stringify(user));\r\n    else localStorage.removeItem(\"user\");\r\n  }, [user]);\r\n\r\n  /* -------------------- Refresh timer -------------------- */\r\n  const refreshTimerRef = useRef(null);\r\n\r\n  const clearRefreshTimer = useCallback(() => {\r\n    if (refreshTimerRef.current) {\r\n      clearTimeout(refreshTimerRef.current);\r\n      refreshTimerRef.current = null;\r\n    }\r\n  }, []);\r\n\r\n  const parseJwt = useCallback((token) => {\r\n    try {\r\n      const payload = token.split(\".\")[1];\r\n      const json = atob(payload.replace(/-/g, \"+\").replace(/_/g, \"/\"));\r\n      return JSON.parse(json);\r\n    } catch {\r\n      return null;\r\n    }\r\n  }, []);\r\n\r\n  const scheduleRefresh = useCallback(\r\n    (token) => {\r\n      clearRefreshTimer();\r\n\r\n      try {\r\n        const payload = parseJwt(token);\r\n        if (!payload || !payload.exp) return;\r\n\r\n        const expiresAt = payload.exp * 1000;\r\n        const now = Date.now();\r\n        const timeout = Math.max(1000, expiresAt - now - 60 * 1000);\r\n\r\n        refreshTimerRef.current = setTimeout(async () => {\r\n          try {\r\n            const res = await apiRefreshToken();\r\n            const newToken = res?.token;\r\n            if (newToken) {\r\n              localStorage.setItem(\"authToken\", newToken);\r\n              scheduleRefresh(newToken);\r\n            }\r\n          } catch {\r\n            // ðŸ”’ IMPORTANT: Do nothing if backend is restarting\r\n          }\r\n        }, timeout);\r\n      } catch {\r\n        // ignore\r\n      }\r\n    },\r\n    [clearRefreshTimer, parseJwt],\r\n  );\r\n\r\n  /* -------------------- Initial auth check -------------------- */\r\n  useEffect(() => {\r\n    let mounted = true;\r\n\r\n    async function checkAuth() {\r\n      try {\r\n        if (user) {\r\n          // ðŸ”’ Still verify with backend to ensure token is valid & schedule refresh\r\n          const token = localStorage.getItem(\"authToken\");\r\n          if (token) scheduleRefresh(token);\r\n        }\r\n\r\n        const res = await api.get(\"/auth/me\");\r\n        if (mounted) setUser(res.data || null);\r\n\r\n        const token = localStorage.getItem(\"authToken\");\r\n        if (token) scheduleRefresh(token);\r\n      } catch {\r\n        // not logged in or session expired\r\n        setUser(null);\r\n        localStorage.removeItem(\"user\");\r\n        localStorage.removeItem(\"authToken\");\r\n      } finally {\r\n        if (mounted) setLoading(false);\r\n      }\r\n    }\r\n\r\n    checkAuth();\r\n\r\n    return () => {\r\n      mounted = false;\r\n    };\r\n  }, [scheduleRefresh]);\r\n\r\n  /* -------------------- LOGIN -------------------- */\r\n  const login = async (data) => {\r\n    if (!data?.token) throw new Error(\"Missing auth token\");\r\n\r\n    localStorage.setItem(\"authToken\", data.token);\r\n\r\n    const me = await api.get(\"/auth/me\");\r\n    const userObj = {\r\n      ...(me.data || {}),\r\n      role: data.role,\r\n      token: data.token,\r\n    };\r\n\r\n    setUser(userObj);\r\n    scheduleRefresh(data.token);\r\n    return userObj;\r\n  };\r\n\r\n  /* -------------------- LOGOUT (CRITICAL FIX) -------------------- */\r\n  const logout = async () => {\r\n    // ðŸ”´ HARD STOP all background refresh\r\n    clearRefreshTimer();\r\n\r\n    try {\r\n      await apiLogout(); // best effort\r\n    } catch {\r\n      // ignore\r\n    }\r\n\r\n    // ðŸ”´ Clear all auth state\r\n    setUser(null);\r\n    localStorage.removeItem(\"user\");\r\n    localStorage.removeItem(\"authToken\");\r\n\r\n    try {\r\n      sessionStorage.clear();\r\n    } catch {\r\n      // ignore\r\n    }\r\n  };\r\n\r\n  /* -------------------- SAFETY CLEANUP -------------------- */\r\n  useEffect(() => {\r\n    return () => {\r\n      clearRefreshTimer();\r\n    };\r\n  }, [clearRefreshTimer]);\r\n\r\n  return (\r\n    <AuthContext.Provider value={{ user, login, logout, loading }}>\r\n      {children}\r\n    </AuthContext.Provider>\r\n  );\r\n}\r\n\r\nexport function useAuth() {\r\n  const ctx = useContext(AuthContext);\r\n  if (!ctx) {\r\n    throw new Error(\"useAuth must be used inside AuthProvider\");\r\n  }\r\n  return ctx;\r\n}\r\n"],"mappings":"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","ignoreList":[]},"metadata":{},"sourceType":"module","externalDependencies":[]}